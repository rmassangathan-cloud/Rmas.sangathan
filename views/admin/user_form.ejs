<%
/*
  views/admin/user_form.ejs
  New User creation form with cascading location dropdowns.

  Expects:
    - currentUser (object) available in render context
      e.g. currentUser.role (string like 'superadmin' or 'state_president')
    - user (optional) - if provided, this is an edit form
*/

// Extract current user's level from role
let canCreateUsers = true;
let currentUserLevel = 'state';
if (currentUser && currentUser.role) {
  if (currentUser.role.startsWith('block_') || currentUser.role.includes('media_incharge')) {
    canCreateUsers = false;
  }
  if (currentUser.role.startsWith('state_')) currentUserLevel = 'state';
  else if (currentUser.role.startsWith('division_')) currentUserLevel = 'division';
  else if (currentUser.role.startsWith('district_')) currentUserLevel = 'district';
  else if (currentUser.role.startsWith('block_')) currentUserLevel = 'block';
  else if (currentUser.role === 'superadmin') currentUserLevel = 'super';
}
%>

<section class="admin-user-form">
  <div class="container" style="max-width:800px;margin:20px auto;padding:20px;border:1px solid #eee;border-radius:8px;">
    <h2><% if (user && user._id) { %>Edit User<% } else { %>Create New User<% } %></h2>

    <% if (!canCreateUsers) { %>
      <div style="padding:20px;background:#f8d7da;border:1px solid #f5c6cb;border-radius:4px;color:#721c24;">
        <strong>‚ùå Authorization Error</strong><br>
        You are not authorized to create users. Only Superadmin, State, Division, and District level users can create new users.
      </div>
    <% } else { %>
      <% let formAction = '/admin/users'; if (user && user._id) { formAction = '/admin/users/' + user._id; } %>
      <form id="userForm" method="POST" action="<%= formAction %>" novalidate>

        <div style="margin-bottom:12px;">
          <label for="name">Name <span style="color:red">*</span></label>
          <input id="name" name="name" type="text" required value="<%= user && user.name ? user.name : '' %>" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" />
        </div>

        <div style="margin-bottom:12px;">
          <label for="email">Email <span style="color:red">*</span></label>
          <input id="email" name="email" type="email" required value="<%= user && user.email ? user.email : '' %>" <% if (user && user._id) { %>readonly<% } %> style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" />
        </div>

        <div style="margin-bottom:12px;">
          <label for="password">
            <% if (!user || !user._id) { %>
              Password (optional)
            <% } else { %>
              Password (leave blank to keep current)
            <% } %>
          </label>
          <input id="password" name="password" type="password" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;" />
        </div>

        <!-- Role options limited to 3 user-facing roles -->
        <div style="margin-bottom:12px;">
          <label for="roleSelect">Role <span style="color:red">*</span></label>
          <select id="roleSelect" name="roleFace" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
            <option value="">-- Select Role --</option>
            <option value="president">President</option>
            <option value="secretary">Secretary</option>
            <option value="media_incharge">Media Incharge</option>
          </select>
        </div>

        <!-- Assigned Level (state/division/district/block) -->
        <div style="margin-bottom:12px;">
          <label for="assignedLevel">Assigned Level <span style="color:red">*</span></label>
          <select id="assignedLevel" name="_assignedLevel_display" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
            <option value="">-- Select Level --</option>
            <% if (currentUser && currentUser.role === 'superadmin') { %>
              <option value="state">State Level</option>
              <option value="division">Division Level</option>
              <option value="district">District Level</option>
              <option value="block">Block Level</option>
            <% } else if (currentUser && currentUser.role.startsWith('state_')) { %>
              <option value="division">Division Level</option>
              <option value="district">District Level</option>
              <option value="block">Block Level</option>
            <% } else if (currentUser && currentUser.role.startsWith('division_')) { %>
              <option value="district">District Level</option>
              <option value="block">Block Level</option>
            <% } else if (currentUser && currentUser.role.startsWith('district_')) { %>
              <option value="block">Block Level</option>
            <% } else { %>
              <option value="" disabled>No lower levels available</option>
            <% } %>
          </select>
          <p class="hint" style="margin:6px 0 0;font-size:0.9em;color:#666;">
            <% if (currentUser && currentUser.role === 'superadmin') { %>
              You are superadmin: you can assign at any level.
            <% } else { %>
              You have restricted assignment rights based on your role.
            <% } %>
          </p>
        </div>

        <!-- Cascading assignment controls -->
        <div id="assignmentContainer" style="margin-bottom:12px;">
          <!-- State -->
          <div id="stateGroup" style="display:none;margin-top:8px;">
            <label for="stateSelect">State <span style="color:red">*</span></label>
            <select id="stateSelect" name="state" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;"></select>
          </div>

          <!-- Division -->
          <div id="divisionGroup" style="display:none;margin-top:8px;">
            <label for="divisionSelect">Division <span style="color:red">*</span></label>
            <select id="divisionSelect" name="division" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
              <option value="">-- Select Division --</option>
            </select>
          </div>

          <!-- District -->
          <div id="districtGroup" style="display:none;margin-top:8px;">
            <label for="districtSelect">District <span style="color:red">*</span></label>
            <select id="districtSelect" name="district" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
              <option value="">-- Select District --</option>
            </select>
          </div>

          <!-- Block -->
          <div id="blockGroup" style="display:none;margin-top:8px;">
            <label for="blockSelect">Block <span style="color:red">*</span></label>
            <select id="blockSelect" name="block" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
              <option value="">-- Select Block --</option>
            </select>
          </div>
        </div>

        <!-- Active Status -->
        <div style="margin-bottom:12px;">
          <label>
            <input type="checkbox" name="active" value="on" <% if (!user || user.active !== false) { %>checked<% } %> style="margin-right:6px;" />
            Active User
          </label>
        </div>

        <!-- Hidden fields for server validation -->
        <input type="hidden" id="finalRole" name="role" />
        <input type="hidden" id="hiddenAssignedLevel" name="assignedLevel" />
        <input type="hidden" id="hiddenAssignedId" name="assignedId" />

        <div style="margin-top:12px;">
          <button type="submit" id="submitBtn" class="btn btn-primary" style="padding:10px 18px;background:#007bff;color:#fff;border:none;border-radius:4px;">Create User</button>
        </div>
      </form>
    <% } %>
  </div>
</section>

<!-- Link external JS file (CSP compliant) -->
<script src="/js/admin-user-form.js"></script>
