<section class="admin-form-view">
  <div class="container" style="max-width:1100px;margin:30px auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <h2>Application: <%= form.fullName %></h2>
      <a href="/admin/forms" class="btn" style="padding:8px 15px;background:#6c757d;color:white;text-decoration:none;border-radius:4px;">&larr; Back to List</a>
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:30px;">
      
      <!-- Left Column: Application Details -->
      <div style="flex:2;min-width:300px;background:#fff;padding:20px;border:1px solid #ddd;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.05);">
        <div style="display:flex;gap:20px;margin-bottom:20px;">
          <% if(form.photo) { %>
            <img src="<%= form.photo %>" alt="Applicant Photo" style="width:120px;height:150px;object-fit:cover;border:1px solid #ccc;border-radius:4px;">
          <% } else { %>
            <div style="width:120px;height:150px;background:#eee;display:flex;align-items:center;justify-content:center;color:#888;">No Photo</div>
          <% } %>
          
          <div>
            <h3 style="margin-top:0;"><%= form.fullName %></h3>
            <% const statusClass = form.status === 'accepted' ? 'status-accepted' : (form.status === 'rejected' ? 'status-rejected' : 'status-pending'); %>
            <p style="margin:5px 0;"><strong>Status:</strong> 
              <span class="status-badge <%= statusClass %>">
                <%= form.status.toUpperCase() %>
              </span>
            </p>
            <p style="margin:5px 0;"><strong>Mobile:</strong> <%= form.mobile %></p>
            <p style="margin:5px 0;"><strong>Email:</strong> <%= form.email || 'N/A' %></p>
            <p style="margin:5px 0;"><strong>Applied:</strong> <%= new Date(form.createdAt).toLocaleString() %></p>
          </div>
        </div>

        <hr style="border:0;border-top:1px solid #eee;margin:20px 0;">

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
          <div><strong>Father's Name:</strong><br><%= form.fatherName || '-' %></div>
          <div><strong>Occupation:</strong><br><%= form.occupation || '-' %></div>
          <div><strong>State:</strong><br><%= form.state || '-' %></div>
          <div><strong>District:</strong><br><%= form.district || '-' %></div>
          <div><strong>Block:</strong><br><%= form.block || '-' %></div>
          <div><strong>Village/Panchayat:</strong><br><%= form.village || '-' %> / <%= form.panchayat || '-' %></div>
          <div style="grid-column:1/-1;"><strong>Full Address:</strong><br><%= form.address || '-' %></div>
          <div><strong>Pincode:</strong><br><%= form.pincode || '-' %></div>
          <div><strong>ID Number:</strong><br><%= form.idNumber || '-' %></div>
        </div>

        <hr style="border:0;border-top:1px solid #eee;margin:20px 0;">

        <div style="margin-bottom:20px;">
          <strong>Reason for Joining:</strong>
          <p style="background:#f9f9f9;padding:10px;border-radius:4px;"><%= form.reason %></p>
        </div>

        <div>
          <strong>Character Certificate:</strong><br>
          <% const certUrl = form.documentsUrl || form.characterCertUrl; %>
          <% if(certUrl) { %>
            <a href="<%= certUrl %>" download="Character_Certificate_<%= form.fullName.replace(/\s+/g, '_') %>.pdf" class="btn" style="display:inline-block;margin-top:5px;padding:10px 20px;background:#28a745;color:white;text-decoration:none;border-radius:6px;font-weight:bold;border:2px solid #218838;">
              üì• Download Character Certificate PDF
            </a>
            <br>
            <small style="color:#666;margin-top:5px;display:block;">Combined Aadhaar + Character Certificate (PDF format)</small>
            <br>
            <!-- Use iframe instead of embed to avoid object-src CSP blocking -->
            <iframe src="<%= certUrl %>" width="100%" height="600" style="border:1px solid #ddd;border-radius:4px;margin-top:10px;">
              <p>Your browser cannot display PDFs inline. You can <a href="<%= certUrl %>" download>download the PDF</a> instead.</p>
            </iframe>
          <% } else { %>
            <span style="color:#dc3545;font-weight:bold;">‚ùå No Character Certificate attached</span>
          <% } %>
        </div>
      </div>

      <!-- Right Column: Actions & History -->
      <div style="flex:1;min-width:300px;">
        
        <!-- Assignment Box -->
        <div style="background:#fff;padding:20px;border:1px solid #ddd;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 5px rgba(0,0,0,0.05);">
          <h3 style="margin-top:0;font-size:1.2em;">Assignment</h3>
          <p><strong>Current Owner:</strong> <%= form.assignedTo ? (form.assignedTo.name || form.assignedTo.email) : 'Unassigned' %></p>
          
          <form method="POST" action="/admin/forms/<%= form._id %>/assign">
            <label style="display:block;margin-bottom:5px;font-size:0.9em;">Assign to:</label>
            <select name="userId" style="width:100%;padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:4px;">
              <option value="">-- Unassigned --</option>
              <% users.forEach(u => { %>
                <option value="<%= u._id %>" <%= (form.assignedTo && form.assignedTo._id.toString() === u._id.toString()) ? 'selected' : '' %>>
                  <%= u.name %> (<%= u.role %>)
                </option>
              <% }) %>
            </select>
            <button class="btn" style="width:100%;padding:8px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;">Update Assignment</button>
          </form>
        </div>

        <!-- Action Box -->
        <div style="background:#fff;padding:20px;border:1px solid #ddd;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 5px rgba(0,0,0,0.05);">
          <h3 style="margin-top:0;font-size:1.2em;">Take Action</h3>
          <% if(form.status === 'pending') { %>
              <form method="POST" action="/admin/forms/<%= form._id %>/accept" style="margin-bottom:15px;">
              <input type="text" name="note" placeholder="Acceptance Note (Optional)" style="width:100%;padding:8px;margin-bottom:8px;border:1px solid #ccc;border-radius:4px;">
              <p style="font-size:0.9em;color:#666;margin:6px 0 12px;">Role assignment is available after acceptance via the "Manage Role Assignment" button below.</p>
              <button class="btn" style="width:100%;padding:10px;background:#28a745;color:white;border:none;border-radius:4px;cursor:pointer;">Accept Application</button>
            </form>

            <form method="POST" action="/admin/forms/<%= form._id %>/reject">
              <input type="text" name="note" placeholder="Rejection Reason (Required)" required style="width:100%;padding:8px;margin-bottom:5px;border:1px solid #ccc;border-radius:4px;">
              <button class="btn" style="width:100%;padding:10px;background:#dc3545;color:white;border:none;border-radius:4px;cursor:pointer;">Reject Application</button>
            </form>
          <% } else { %>
            <div style="text-align:center;padding:15px;background:#f8f9fa;border-radius:4px;">
              Application is <strong><%= form.status %></strong>.
            </div>
          <% } %>
        </div>

        <!-- Role Assignment Box (for accepted members) -->
        <% if(form.status === 'accepted') { %>
        <div style="background:#fff;padding:20px;border:1px solid #ddd;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 5px rgba(0,0,0,0.05);">
          <h3 style="margin-top:0;font-size:1.2em;">Role Assignment</h3>

          <!-- Show current role assignment -->
          <% if(form.assignedRoles && form.assignedRoles.length > 0) { %>
            <div style="background:#e8f5e8;padding:10px;border-radius:4px;margin-bottom:15px;">
              <p><strong>Current Role:</strong> <%= form.assignedRoles[0].roleName %></p>
              <p><strong>Category:</strong> <%= form.assignedRoles[0].category %></p>
              <p><strong>Team:</strong> <%= form.assignedRoles[0].teamType %></p>
              <p><strong>Level:</strong> <%= form.assignedRoles[0].level %></p>
              <% if(form.assignedRoles[0].location) { %>
                <p><strong>Location:</strong> <%= form.assignedRoles[0].location %></p>
              <% } %>
            </div>
          <% } else if(form.jobRole) { %>
            <!-- Legacy role display -->
            <div style="background:#fff3cd;padding:10px;border-radius:4px;margin-bottom:15px;">
              <p><strong>Legacy Role:</strong> <%= form.jobRole %></p>
              <p><strong>Team:</strong> <%= form.teamType %></p>
              <small style="color:#856404;">This uses the old role system. Click "Manage Role" to upgrade.</small>
            </div>
          <% } else { %>
            <p style="color:#dc3545;">No role assigned yet.</p>
          <% } %>

          <!-- Manage Role Button -->
          <div style="margin-bottom:15px;">
            <a href="/admin/forms/<%= form._id %>/manage-role" class="btn" style="width:100%;padding:10px;background:#28a745;color:white;text-decoration:none;border-radius:4px;display:inline-block;text-align:center;font-weight:bold;">
              üéØ Manage Role Assignment
            </a>
            <small style="display:block;color:#666;margin-top:6px;text-align:center;">Advanced role assignment with cascading selections</small>
          </div>



          <div style="margin-top:10px;">
            <button id="resend-joining-btn" data-form-id="<%= form._id %>" data-email="<%= form.email %>" class="btn" style="width:100%;padding:10px;background:#17a2b8;color:white;border:none;border-radius:4px;cursor:pointer;">
              üì® Resend Joining Letter
            </button>
            <small style="display:block;color:#666;margin-top:6px;">Sends the joining letter PDF to <strong><%= form.email || 'N/A' %></strong></small>
          </div>
        </div>
        <% } %>

        <!-- History Box -->
        <div style="background:#fff;padding:20px;border:1px solid #ddd;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.05);">
          <h3 style="margin-top:0;font-size:1.2em;">Audit Trail</h3>
          <ul style="list-style:none;padding:0;margin:0;font-size:0.9em;">
            <% if(form.history && form.history.length) { %>
              <% form.history.slice().reverse().forEach(h => { %>
                <li style="border-bottom:1px solid #eee;padding-bottom:10px;margin-bottom:10px;">
                  <div style="font-weight:bold;color:#333;"><%= h.action.toUpperCase() %></div>
                  <div style="color:#666;font-size:0.85em;">
                    By: <%= h.role || 'System' %> <br>
                    <%= new Date(h.date || h.timestamp).toLocaleString() %>
                  </div>
                  <% if(h.note) { %>
                    <div style="margin-top:3px;font-style:italic;color:#555;">"<%= h.note %>"</div>
                  <% } %>
                </li>
              <% }) %>
            <% } else { %>
              <li style="color:#888;">No history recorded.</li>
            <% } %>
          </ul>
        </div>

      </div>
    </div>
  </div>

  <script src="/js/admin-form.js" defer></script>

  <style>
    .status-badge { padding:3px 8px;border-radius:12px;font-size:0.9em;display:inline-block;color:#fff }
    .status-accepted { background:#28a745; }
    .status-rejected { background:#dc3545; }
    .status-pending { background:#ffc107;color:#333 }
  </style>
</section>
