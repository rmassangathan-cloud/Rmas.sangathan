<% console.log('ðŸŽ¨ Rendering change-password template'); %>
<% console.log('âœ… currentUser exists:', !!currentUser); %>
<% console.log('ðŸ‘¤ currentUser.name:', currentUser?.name); %>
<% console.log('ðŸ“§ currentUser.email:', currentUser?.email); %>
<% console.log('ðŸ” currentUser.passwordChanged:', currentUser?.passwordChanged); %>

<section class="admin-change-password" style="min-height: 60vh; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
  <div class="container" style="max-width: 500px; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h2 style="text-align: center; margin-bottom: 20px; color: #333;">Change Password</h2>
    <p style="text-align: center; color: #666; margin-bottom: 25px; font-size: 14px;">
      <% if (!currentUser?.passwordChanged) { %>
        This is your first login. Please set a new password to continue.
      <% } else { %>
        Enter your current password and choose a new one.
      <% } %>
    </p>

    <% if (error) { %>
      <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 10px; border-radius: 4px; margin-bottom: 20px; font-size: 14px;">
        <%= error %>
      </div>
    <% } %>

    <% if (success) { %>
      <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 20px; font-size: 14px;">
        <%= success %>
        <% if (success && success.includes('successfully')) { %>
          <br><br>
          <a href="/admin" style="color: #155724; text-decoration: underline;">Continue to Dashboard</a>
        <% } %>
      </div>
    <% } %>

    <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 4px; margin-bottom: 20px; font-size: 14px;">
      <strong>Password Requirements:</strong><br>
      â€¢ At least 8 characters<br>
      â€¢ At least 1 uppercase letter (A-Z)<br>
      â€¢ At least 1 lowercase letter (a-z)<br>
      â€¢ At least 1 number (0-9)<br>
      â€¢ At least 1 special character (!@#$%^&* etc.)
    </div>

    <form method="POST" action="/admin/change-password" style="margin-bottom: 20px;">
      <% if (currentUser?.passwordChanged) { %>
        <div style="margin-bottom: 15px;">
          <label for="currentPassword" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Current Password <span style="color:red">*</span></label>
          <input type="password" id="currentPassword" name="currentPassword" required
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
                 placeholder="Enter current password">
        </div>
      <% } %>

      <div style="margin-bottom: 15px;">
        <label for="newPassword" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">New Password <span style="color:red">*</span></label>
        <input type="password" id="newPassword" name="newPassword" required
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
               placeholder="Enter new password" minlength="8">
      </div>

      <div style="margin-bottom: 20px;">
        <label for="confirmPassword" style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Confirm New Password <span style="color:red">*</span></label>
        <input type="password" id="confirmPassword" name="confirmPassword" required
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;"
               placeholder="Confirm new password" minlength="8">
      </div>

      <button type="submit" style="width: 100%; background: #007bff; color: white; border: none; padding: 12px; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background 0.3s;">
        <% if (!currentUser?.passwordChanged) { %>
          Set Password & Continue
        <% } else { %>
          Change Password
        <% } %>
      </button>
    </form>

    <div style="text-align: center;">
      <a href="/admin" style="color: #007bff; text-decoration: none; font-size: 14px;">Back to Dashboard</a>
    </div>
  </div>
</section>

<script>
// Simple client-side validation
document.querySelector('form').addEventListener('submit', function(e) {
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;

  if (newPassword !== confirmPassword) {
    alert('New passwords do not match!');
    e.preventDefault();
    return;
  }

  // Basic password strength check
  const minLength = newPassword.length >= 8;
  const hasUpper = /[A-Z]/.test(newPassword);
  const hasLower = /[a-z]/.test(newPassword);
  const hasNumber = /\d/.test(newPassword);
  const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(newPassword);

  if (!minLength || !hasUpper || !hasLower || !hasNumber || !hasSpecial) {
    alert('Password does not meet the requirements. Please check the password requirements above.');
    e.preventDefault();
    return;
  }
});
</script>
